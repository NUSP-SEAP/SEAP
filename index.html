<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checklist Diário</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f4f7f6;
            color: #333;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #ffffff;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        h1 {
            text-align: center;
            color: #222;
        }

        #userInfo {
            text-align: right;
            margin-bottom: 20px;
            font-size: 0.9em;
            color: #555;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
        }

        input[type="text"],
        input[type="date"],
        input[type="time"],
        select,
        textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
            /* Importante para o padding não quebrar o layout */
        }

        .check-item {
            border: 1px solid #eee;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 15px;
        }

        .check-item-label {
            font-weight: 600;
            margin-bottom: 10px;
            display: block;
        }

        .check-item input[type="radio"] {
            margin-right: 5px;
        }

        .check-item label {
            display: inline-block;
            margin-right: 20px;
            font-weight: 500;
        }

        .falha-descricao {
            display: none;
            width: 100%;
            margin-top: 15px;
        }

        button {
            width: 100%;
            padding: 15px;
            background-color: #0078d4;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        button:hover {
            background-color: #005a9e;
        }

        #statusMessage {
            margin-top: 20px;
            text-align: center;
            font-size: 1.1em;
        }
    </style>
</head>

<body>

    <div class="container">
        <h1>Checklist Diário</h1> [cite: 1]
        <div id="userInfo">Carregando usuário...</div>

        <form id="checklistForm">
            <input type="hidden" id="userEmail" name="userEmail">

            <div class="form-group">
                <label for="dataOperacao">Data da Operação:</label> [cite: 3]
                <input type="date" id="dataOperacao" name="dataOperacao" required>
            </div>

            <div class="form-group">
                <label for="local">Plenário/Sala:</label> [cite: 4]
                <select id="local" name="local" required>
                    <option value="">Selecione um local...</option>
                    <option value="Auditório">Auditório</option> [cite: 5]
                    <option value="Plenário">Plenário</option> [cite: 7]
                    <option value="Sala 02">Sala 02</option> [cite: 9]
                    <option value="Sala 03">Sala 03</option> [cite: 11]
                    <option value="Sala 06">Sala 06</option> [cite: 12]
                    <option value="Sala 07">Sala 07</option> [cite: 13]
                    <option value="Sala 09">Sala 09</option> [cite: 15]
                    <option value="Sala 13">Sala 13</option> [cite: 17]
                    <option value="Sala 15">Sala 15</option> [cite: 18]
                    <option value="Sala 19">Sala 19</option> [cite: 20]
                </select>
            </div>

            <div class="form-group">
                <label for="turno">Turno:</label> [cite: 21]
                <select id="turno" name="turno" required>
                    <option value="">Selecione um turno...</option>
                    <option value="Matutino">Matutino</option> [cite: 22]
                    <option value="Vespertino">Vespertino</option> [cite: 23]
                </select>
            </div>

            <div class="form-group">
                <label for="horaInicio">Horário de início dos testes:</label> [cite: 24]
                <input type="time" id="horaInicio" name="horaInicio" required>
            </div>

            <div class="form-group">
                <p>Status dos Equipamentos (Marque "Ok" ou "Falha"):</p> [cite: 26]

                <div class="check-item">
                    <span class="check-item-label">Sistema Zoom</span> [cite: 30]
                    <label><input type="radio" name="sistemaZoom" value="Ok" required> Ok</label>
                    <label><input type="radio" name="sistemaZoom" value="Falha"> Falha</label>
                    <textarea id="falhaSistemaZoom" name="falhaSistemaZoom" class="falha-descricao"
                        placeholder="Descreva a falha..."></textarea> [cite: 27]
                </div>

                <div class="check-item">
                    <span class="check-item-label">PC do Secretário</span> [cite: 31]
                    <label><input type="radio" name="pcSecretario" value="Ok" required> Ok</label>
                    <label><input type="radio" name="pcSecretario" value="Falha"> Falha</label>
                    <textarea id="falhaPcSecretario" name="falhaPcSecretario" class="falha-descricao"
                        placeholder="Descreva a falha..."></textarea>
                </div>

                <div class="check-item">
                    <span class="check-item-label">Vídeowall</span> [cite: 32]
                    <label><input type="radio" name="videowall" value="Ok" required> Ok</label>
                    <label><input type="radio" name="videowall" value="Falha"> Falha</label>
                    <textarea id="falhaVideowall" name="falhaVideowall" class="falha-descricao"
                        placeholder="Descreva a falha..."></textarea>
                </div>

                <div class="check-item">
                    <span class="check-item-label">Mic sem fio</span> [cite: 34]
                    <label><input type="radio" name="micSemFio" value="Ok" required> Ok</label>
                    <label><input type="radio" name="micSemFio" value="Falha"> Falha</label>
                    <textarea id="falhaMicSemFio" name="falhaMicSemFio" class="falha-descricao"
                        placeholder="Descreva a falha..."></textarea>
                </div>

                <div class="check-item">
                    <span class="check-item-label">Mic de bancada</span> [cite: 35]
                    <label><input type="radio" name="micBancada" value="Ok" required> Ok</label>
                    <label><input type="radio" name="micBancada" value="Falha"> Falha</label>
                    <textarea id="falhaMicBancada" name="falhaMicBancada" class="falha-descricao"
                        placeholder="Descreva a falha..."></textarea>
                </div>

                <div class="check-item">
                    <span class="check-item-label">Sinal TV Senado</span> [cite: 36]
                    <label><input type="radio" name="sinalTVSenado" value="Ok" required> Ok</label>
                    <label><input type="radio" name="sinalTVSenado" value="Falha"> Falha</label>
                    <textarea id="falhaSinalTVSenado" name="falhaSinalTVSenado" class="falha-descricao"
                        placeholder="Descreva a falha..."></textarea>
                </div>

                <div class="check-item">
                    <span class="check-item-label">Tablet Presidente</span> [cite: 37]
                    <label><input type="radio" name="tabletPresidente" value="Ok" required> Ok</label>
                    <label><input type="radio" name="tabletPresidente" value="Falha"> Falha</label>
                    <textarea id="falhaTabletPresidente" name="falhaTabletPresidente" class="falha-descricao"
                        placeholder="Descreva a falha..."></textarea>
                </div>

                <div class="check-item">
                    <span class="check-item-label">Tablet Secretária</span> [cite: 40]
                    <label><input type="radio" name="tabletSecretaria" value="Ok" required> Ok</label>
                    <label><input type="radio" name="tabletSecretaria" value="Falha"> Falha</label>
                    <textarea id="falhaTabletSecretaria" name="falhaTabletSecretaria" class="falha-descricao"
                        placeholder="Descreva a falha..."></textarea>
                </div>

                <div class="check-item">
                    <span class="check-item-label">Relógio (sincronismo)</span> [cite: 41]
                    <label><input type="radio" name="relogio" value="Ok" required> Ok</label>
                    <label><input type="radio" name="relogio" value="Falha"> Falha</label>
                    <textarea id="falhaRelogio" name="falhaRelogio" class="falha-descricao"
                        placeholder="Descreva a falha..."></textarea>
                </div>

                <div class="check-item">
                    <span class="check-item-label">VIP</span> [cite: 39]
                    <label><input type="radio" name="vip" value="Ok" required> Ok</label>
                    <label><input type="radio" name="vip" value="Falha"> Falha</label>
                    <textarea id="falhaVip" name="falhaVip" class="falha-descricao"
                        placeholder="Descreva a falha..."></textarea>
                </div>

            </div>

            <div class="form-group">
                <label for="horaTermino">Horário de término dos testes:</label> [cite: 42]
                <input type="time" id="horaTermino" name="horaTermino" required>
            </div>

            <div class="form-group">
                <label for="observacoes">Observações gerais:</label>
                <textarea id="observacoes" name="observacoes" rows="5"
                    placeholder="Alguma observação adicional..."></textarea>
            </div>

            <button type="submit">Enviar Checklist</button>

            <div id="statusMessage"></div>
        </form>
    </div>

    <script>
        // ##################################################################
        // CONFIGURE AQUI A URL DO SEU WEBHOOK DO N8N (Self-Hosted no ACA)
        // ##################################################################
        const N8N_WEBHOOK_URL = "https://n8n-app-final.kindtree-6808ca28.brazilsouth.azurecontainerapps.io/";
        // ##################################################################


        document.addEventListener('DOMContentLoaded', () => {
            fetchUser();
            setupConditionalLogic();
            setupFormSubmission();
        });

        /**
         * Busca informações do usuário autenticado pelo Azure Static Web Apps
         */
        async function fetchUser() {
            const userInfoDiv = document.getElementById('userInfo');
            const userEmailInput = document.getElementById('userEmail');
            try {
                const response = await fetch('/.auth/me');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();

                if (data.clientPrincipal) {
                    const email = data.clientPrincipal.userDetails;
                    userInfoDiv.textContent = `Logado como: ${email}`;
                    userEmailInput.value = email;
                } else {
                    userInfoDiv.textContent = 'Usuário não autenticado. Faça login para continuar.';
                    // Em um SWA com autenticação forçada, isso redirecionaria para o login
                }
            } catch (error) {
                console.error('Erro ao buscar usuário:', error);
                userInfoDiv.textContent = 'Erro ao verificar autenticação.';
            }
        }

        /**
         * Configura a lógica condicional para os campos de falha
         */
        function setupConditionalLogic() {
            const radioButtons = document.querySelectorAll('.check-item input[type="radio"]');

            radioButtons.forEach(radio => {
                radio.addEventListener('change', (e) => {
                    // Constrói o ID do textarea de falha (ex: "falha" + "SistemaZoom")
                    const name = e.target.name;
                    const falhaTextarea = document.getElementById('falha' + name.charAt(0).toUpperCase() + name.slice(1));

                    if (falhaTextarea) {
                        if (e.target.value === 'Falha' && e.target.checked) {
                            falhaTextarea.style.display = 'block'; // [cite: 27]
                        } else {
                            falhaTextarea.style.display = 'none'; // [cite: 29]
                            falhaTextarea.value = ''; // Limpa o campo ao ocultar
                        }
                    }
                });
            });
        }

        /**
         * Configura o envio do formulário para o Webhook do n8n
         */
        function setupFormSubmission() {
            const form = document.getElementById('checklistForm');
            const statusMessage = document.getElementById('statusMessage');

            form.addEventListener('submit', async (e) => {
                e.preventDefault(); // Impede o envio HTML padrão

                if (N8N_WEBHOOK_URL === "COLE_A_URL_DO_SEU_WEBHOOK_N8N_AQUI") {
                    statusMessage.textContent = 'Erro: A URL do Webhook do n8n não foi configurada no JavaScript.';
                    statusMessage.style.color = 'red';
                    return;
                }

                // Verifica se o email foi carregado
                if (!document.getElementById('userEmail').value) {
                    statusMessage.textContent = 'Erro: Não foi possível obter o e-mail do usuário. Verifique se está logado.';
                    statusMessage.style.color = 'red';
                    return;
                }

                statusMessage.textContent = 'Enviando...';
                statusMessage.style.color = '#333';

                // Coleta todos os dados do formulário
                const formData = new FormData(form);
                const data = Object.fromEntries(formData.entries());

                try {
                    const response = await fetch(N8N_WEBHOOK_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(data),
                    });

                    if (response.ok) {
                        statusMessage.textContent = 'Checklist enviado com sucesso!';
                        statusMessage.style.color = 'green';
                        form.reset();
                        // Reseta manualmente os campos de falha (o reset do form não dispara o 'change')
                        document.querySelectorAll('.falha-descricao').forEach(area => {
                            area.style.display = 'none';
                        });
                        // Recarrega o usuário (pois o campo oculto foi limpo)
                        fetchUser();
                    } else {
                        // Tenta ler a resposta de erro do n8n
                        const errorData = await response.json();
                        console.error('Erro do n8n:', errorData);
                        statusMessage.textContent = `Erro ao enviar: ${errorData.message || 'O servidor retornou um erro.'}`;
                        statusMessage.style.color = 'red';
                    }
                } catch (error) {
                    console.error('Erro de rede:', error);
                    statusMessage.textContent = 'Erro de rede. Verifique sua conexão ou a URL do Webhook.';
                    statusMessage.style.color = 'red';
                }
            });
        }
    </script>

</body>

</html>